<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>platypus - Web App Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #0f62fe;
        }

        .app-content {
            background: white;
            border-radius: 4px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .element {
            margin-bottom: 20px;
        }

        .text {
            font-size: 16px;
            line-height: 1.5;
        }

        .heading {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .heading-1 {
            font-size: 32px;
        }

        .heading-2 {
            font-size: 24px;
        }

        .heading-3 {
            font-size: 20px;
        }

        button {
            background: #0f62fe;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #0353e9;
        }

        button:active {
            background: #002d9c;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            margin-top: 5px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0f62fe;
            box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.1);
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d0f0d0;
            color: #24a148;
            border-left: 4px solid #24a148;
        }

        .alert-error {
            background: #fdd2d2;
            color: #da1e28;
            border-left: 4px solid #da1e28;
        }

        .alert-warning {
            background: #fef3c7;
            color: #b8860b;
            border-left: 4px solid #b8860b;
        }

        .alert-info {
            background: #d0e8f2;
            color: #0043ce;
            border-left: 4px solid #0043ce;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0f62fe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status.connected {
            color: #24a148;
        }

        .status.disconnected {
            color: #da1e28;
        }

        .columns-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .column {
            flex: 1;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ðŸš€ platypus</h1>
            <p>Web App Generator - Built with Rust</p>
        </div>
    </header>

    <div class="container">
        <div class="app-content">
            <div id="app"></div>
        </div>
    </div>

    <div id="status" class="status disconnected">
        <span class="loading"></span>
        <span>Connecting...</span>
    </div>

    <script>
        // WebSocket connection
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

        const statusEl = document.getElementById('status');
        const appEl = document.getElementById('app');
        let elements = {}; // Store rendered elements by ID

        ws.onopen = () => {
            statusEl.className = 'status connected';
            statusEl.innerHTML = '<span>âœ“ Connected</span>';
            console.log('WebSocket connected');
        };

        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                console.log('Received message:', message);
                
                if (message.type === 'delta') {
                    renderElements(message.elements);
                } else if (message.type === 'button_click') {
                    console.log('Button click response:', message);
                }
            } catch (e) {
                console.error('Failed to parse message:', e);
            }
        };

        function renderElements(elements) {
            appEl.innerHTML = '';
            
            // Build a map of elements by ID for easier lookup
            const elementMap = {};
            elements.forEach(delta => {
                if (delta.type === 'add_element') {
                    elementMap[delta.element.id] = delta.element;
                }
            });
            
            // Render top-level elements
            let consecutiveColumns = [];
            elements.forEach(delta => {
                if (delta.type === 'add_element' && !delta.element.parent_id) {
                    if (delta.element.type === 'column') {
                        consecutiveColumns.push(delta.element);
                    } else {
                        // Flush any accumulated columns
                        if (consecutiveColumns.length > 0) {
                            const columnsContainer = document.createElement('div');
                            columnsContainer.className = 'columns-container';
                            consecutiveColumns.forEach(col => {
                                const el = renderElement(col, elementMap);
                                if (el) columnsContainer.appendChild(el);
                            });
                            appEl.appendChild(columnsContainer);
                            consecutiveColumns = [];
                        }
                        // Render non-column element
                        const el = renderElement(delta.element, elementMap);
                        if (el) appEl.appendChild(el);
                    }
                }
            });
            
            // Flush any remaining columns
            if (consecutiveColumns.length > 0) {
                const columnsContainer = document.createElement('div');
                columnsContainer.className = 'columns-container';
                consecutiveColumns.forEach(col => {
                    const el = renderElement(col, elementMap);
                    if (el) columnsContainer.appendChild(el);
                });
                appEl.appendChild(columnsContainer);
            }
        }

        function renderElement(element, elementMap = {}) {
            const div = document.createElement('div');
            div.className = 'element';
            
            switch (element.type) {
                case 'column':
                    div.className = 'column';
                    // Render children if they exist
                    if (element.children && element.children.length > 0) {
                        element.children.forEach(childId => {
                            const child = elementMap[childId];
                            if (child) {
                                const childEl = renderElement(child, elementMap);
                                if (childEl) {
                                    div.appendChild(childEl);
                                }
                            }
                        });
                    }
                    return div;
                
                case 'container':
                    div.className = 'container';
                    // Render children if they exist
                    if (element.children && element.children.length > 0) {
                        element.children.forEach(childId => {
                            const child = elementMap[childId];
                            if (child) {
                                const childEl = renderElement(child, elementMap);
                                if (childEl) {
                                    div.appendChild(childEl);
                                }
                            }
                        });
                    }
                    return div;
                
                case 'text':
                    div.textContent = element.value;
                    div.className += ' text';
                    return div;
                    
                case 'markdown':
                    div.innerHTML = markdownToHtml(element.value);
                    return div;
                    
                case 'heading':
                    div.className += ` heading heading-${element.level}`;
                    div.textContent = element.value;
                    return div;
                    
                case 'button':
                    const btn = document.createElement('button');
                    btn.textContent = element.label;
                    btn.onclick = () => {
                        console.log('Button clicked:', element.key);
                        sendButtonClick(element.key);
                    };
                    return btn;
                    
                case 'text_input':
                    const label1 = document.createElement('label');
                    label1.textContent = element.label;
                    const input1 = document.createElement('input');
                    input1.type = 'text';
                    const storedTextValue = widgetValues[element.key];
                    input1.value = storedTextValue !== undefined ? storedTextValue : (element.value || '');
                    updateWidgetValue(element.key, input1.value);
                    const handleTextChange = () => {
                        sendWidgetChange(element.key, input1.value);
                    };
                    input1.oninput = handleTextChange;
                    input1.onchange = handleTextChange;
                    const group1 = document.createElement('div');
                    group1.className = 'form-group';
                    group1.appendChild(label1);
                    group1.appendChild(input1);
                    return group1;
                    
                case 'number_input':
                    const label2 = document.createElement('label');
                    label2.textContent = element.label;
                    const input2 = document.createElement('input');
                    input2.type = 'number';
                    const storedValue = widgetValues[element.key];
                    input2.value = storedValue !== undefined ? storedValue : (element.value || 0);
                    updateWidgetValue(element.key, input2.value);
                    const handleNumberChange = () => {
                        sendWidgetChange(element.key, input2.value);
                    };
                    input2.oninput = handleNumberChange;
                    input2.onchange = handleNumberChange;
                    const group2 = document.createElement('div');
                    group2.className = 'form-group';
                    group2.appendChild(label2);
                    group2.appendChild(input2);
                    return group2;
                    
                case 'checkbox':
                    const label3 = document.createElement('label');
                    const input3 = document.createElement('input');
                    input3.type = 'checkbox';
                    const storedCheckValue = widgetValues[element.key];
                    input3.checked = storedCheckValue !== undefined ? (storedCheckValue === 'true') : (element.value || false);
                    updateWidgetValue(element.key, input3.checked.toString());
                    input3.onchange = () => {
                        sendWidgetChange(element.key, input3.checked.toString());
                    };
                    label3.appendChild(input3);
                    label3.appendChild(document.createTextNode(' ' + element.label));
                    const group3 = document.createElement('div');
                    group3.className = 'form-group';
                    group3.appendChild(label3);
                    return group3;
                    
                case 'selectbox':
                    const label4 = document.createElement('label');
                    label4.textContent = element.label;
                    const select = document.createElement('select');
                    element.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        select.appendChild(option);
                    });
                    const storedSelectValue = widgetValues[element.key];
                    if (storedSelectValue !== undefined) {
                        select.value = storedSelectValue;
                    }
                    updateWidgetValue(element.key, select.value);
                    select.onchange = () => {
                        sendWidgetChange(element.key, select.value);
                    };
                    const group4 = document.createElement('div');
                    group4.className = 'form-group';
                    group4.appendChild(label4);
                    group4.appendChild(select);
                    return group4;
                    
                case 'divider':
                    const hr = document.createElement('hr');
                    return hr;
                    
                case 'success':
                    div.className += ' alert alert-success';
                    div.textContent = element.message;
                    return div;
                    
                case 'error':
                    div.className += ' alert alert-error';
                    div.textContent = element.message;
                    return div;
                    
                case 'warning':
                    div.className += ' alert alert-warning';
                    div.textContent = element.message;
                    return div;
                    
                case 'info':
                    div.className += ' alert alert-info';
                    div.textContent = element.message;
                    return div;
                    
                case 'metric':
                    div.innerHTML = `<strong>${element.label}:</strong> ${element.value}`;
                    return div;
                    
                case 'code':
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.textContent = element.value;
                    pre.appendChild(code);
                    return pre;
                    
                default:
                    div.textContent = `[${element.type}]`;
                    return div;
            }
        }

        // Store all widget values
        const widgetValues = {};

        function updateWidgetValue(key, value) {
            widgetValues[key] = value;
            console.log('Updated widget value:', key, value);
        }

        function sendWidgetChange(key, value) {
            if (!key || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }
            
            // Update local widget value
            updateWidgetValue(key, value);
            
            // Send widget change event to server with all current values
            const message = {
                type: 'widget_change',
                key: key,
                value: value,
                all_values: widgetValues
            };
            
            try {
                ws.send(JSON.stringify(message));
                console.log('Sent widget change:', key, value);
            } catch (e) {
                console.error('Failed to send widget change:', e);
            }
        }

        function sendButtonClick(key) {
            if (!key || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }
            
            // Send button click event to server
            const message = {
                type: 'button_click',
                key: key,
                all_values: widgetValues
            };
            
            try {
                ws.send(JSON.stringify(message));
                console.log('Sent button click:', key);
            } catch (e) {
                console.error('Failed to send button click:', e);
            }
        }

        function markdownToHtml(markdown) {
            // Simple markdown to HTML conversion
            let html = markdown
                .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            return html;
        }

        ws.onerror = (error) => {
            statusEl.className = 'status disconnected';
            statusEl.innerHTML = '<span>âœ— Connection error</span>';
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            statusEl.className = 'status disconnected';
            statusEl.innerHTML = '<span>âœ— Disconnected</span>';
            console.log('WebSocket closed');
        };

        // Render initial content
        appEl.innerHTML = `
            <div class="element heading heading-1">Welcome to platypus</div>
            <div class="element text">
                <p>platypus is a high-performance web app generator built with Rust.</p>
                <p>It provides a Streamlit-compatible API for building interactive web applications.</p>
                <p>Connecting to app...</p>
            </div>
        `;
    </script>
</body>
</html>
